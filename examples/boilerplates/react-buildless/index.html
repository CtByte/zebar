<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" type="text/css" href="../../normalize.css" />
    <link rel="stylesheet" type="text/css" href="./styles.css" />
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://ga.jspm.io/npm:es-module-shims@1.7.0/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react?dev",
          "react-dom/client": "https://esm.sh/react-dom/client?dev",
          "zebar": "https://esm.sh/zebar"
        }
      }
    </script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect } from 'react';
      import { createRoot } from 'react-dom/client';
      import { init } from 'zebar';

      const zebarCtx = await init();

      const [cpu, battery, memory, weather] = await Promise.all([
        zebarCtx.createProvider({ type: 'cpu' }),
        zebarCtx.createProvider({ type: 'battery' }),
        zebarCtx.createProvider({ type: 'memory' }),
        zebarCtx.createProvider({ type: 'weather' }),
      ]);

      createRoot(document.getElementById('root')).render(<App />);

      function App() {
        const [outputs, setOutputs] = useState({
          cpu: cpu.output,
          battery: battery.output,
          memory: memory.output,
          weather: weather.output,
        });

        useEffect(() => {
          cpu.onOutput(cpu =>
            setOutputs(outputs => ({ ...outputs, cpu })),
          );
          battery.onOutput(battery =>
            setOutputs(outputs => ({ ...outputs, battery })),
          );
          memory.onOutput(memory =>
            setOutputs(outputs => ({ ...outputs, memory })),
          );
          weather.onOutput(weather =>
            setOutputs(outputs => ({ ...outputs, weather })),
          );
        }, []);

        return (
          <div className="app">
            <div className="chip">CPU usage: {outputs.cpu.usage}</div>
            <div className="chip">
              Battery charge: {outputs.battery?.chargePercent}
            </div>
            <div className="chip">
              Memory usage: {outputs.memory.usage}
            </div>
            <div className="chip">
              Weather temp: {outputs.weather?.celsiusTemp}
            </div>
          </div>
        );
      }
    </script>
  </body>
</html>
